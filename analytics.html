<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= appName ?> - åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    
    <!-- Bootstrap 4 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            color: white !important;
            font-weight: 700;
            font-size: 1.3rem;
        }
        
        .navbar-text {
            color: rgba(255,255,255,0.9) !important;
        }
        
        .btn-outline-light {
            border-color: rgba(255,255,255,0.5);
            color: white;
        }
        
        .btn-outline-light:hover {
            background-color: rgba(255,255,255,0.2);
            border-color: white;
            color: white;
        }
        
        .page-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        }
        
        .page-title {
            color: #333;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 0;
        }
        
        .analysis-controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .analysis-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .section-title {
            color: #333;
            font-weight: 700;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: #6f42c1;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #6f42c1;
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(111, 66, 193, 0.15);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #6f42c1;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .metric-change {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .trend-up {
            color: #28a745;
        }
        
        .trend-down {
            color: #dc3545;
        }
        
        .trend-stable {
            color: #6c757d;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            min-height: 400px;
        }
        
        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            color: #6c757d;
            flex-direction: column;
        }
        
        .chart-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #dee2e6;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            padding: 8px 16px;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a32a3 0%, #4a2c8a 100%);
            transform: translateY(-1px);
        }
        
        .btn-outline-primary {
            border-color: #6f42c1;
            color: #6f42c1;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .btn-outline-primary:hover {
            background-color: #6f42c1;
            border-color: #6f42c1;
        }
        
        .form-control {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 8px 12px;
        }
        
        .form-control:focus {
            border-color: #6f42c1;
            box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
        }
        
        .alert {
            border-radius: 12px;
            border: none;
        }
        
        .analysis-tabs {
            margin-bottom: 25px;
        }
        
        .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
            border: none;
            color: #666;
            font-weight: 600;
            margin-right: 5px;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 15px 15px 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .efficiency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .efficiency-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #6f42c1;
        }
        
        .efficiency-percentage {
            font-size: 2.5rem;
            font-weight: 700;
            color: #6f42c1;
            margin-bottom: 10px;
        }
        
        .efficiency-label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .benchmark-comparison {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .comparison-item:last-child {
            margin-bottom: 0;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            z-index: 10;
        }
        
        .recommendation-card {
            border-left: 4px solid #ffc107;
            background: #fff3cd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .recommendation-card.high-priority {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .recommendation-card.medium-priority {
            border-left-color: #fd7e14;
            background: #fed7aa;
        }
        
        .recommendation-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .recommendation-desc {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .trend-indicator i {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="?page=admin-dashboard">
                <i class="fas fa-chart-line"></i> <?= appName ?>
            </a>
            
            <div class="navbar-nav ml-auto">
                <span class="navbar-text mr-3">
                    <i class="fas fa-user-shield"></i> <?= user.name || user.email ?>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </div>
    </nav>
    
    <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-chart-line"></i> åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </h1>
            <p class="page-subtitle">
                CO2é™¤å»åŠ¹ç‡ã€ç’°å¢ƒãƒ‡ãƒ¼ã‚¿ãƒˆãƒ¬ãƒ³ãƒ‰ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯”è¼ƒåˆ†æ
            </p>
        </div>
    </div>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="container">
        <!-- åˆ†æã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="analysis-controls">
            <div class="row">
                <div class="col-md-3">
                    <label for="analysisProject">åˆ†æå¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</label>
                    <select class="form-control" id="analysisProject">
                        <option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="analysisPeriod">åˆ†ææœŸé–“</label>
                    <select class="form-control" id="analysisPeriod">
                        <option value="week">éå»1é€±é–“</option>
                        <option value="month" selected>éå»1ãƒ¶æœˆ</option>
                        <option value="quarter">éå»3ãƒ¶æœˆ</option>
                        <option value="year">éå»1å¹´</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="analysisMetric">åˆ†æãƒ¡ãƒˆãƒªãƒƒã‚¯</label>
                    <select class="form-control" id="analysisMetric">
                        <option value="co2">CO2æ¿ƒåº¦</option>
                        <option value="ph">pHå€¤</option>
                        <option value="temperature">æ¸©åº¦</option>
                        <option value="flowRate">æµé‡</option>
                        <option value="removal">CO2é™¤å»é‡</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>&nbsp;</label>
                    <div class="d-flex">
                        <button class="btn btn-primary mr-2" onclick="runAnalysis()">
                            <i class="fas fa-play"></i> åˆ†æå®Ÿè¡Œ
                        </button>
                        <button class="btn btn-outline-primary" onclick="exportAnalysis()">
                            <i class="fas fa-download"></i> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button class="btn btn-success btn-block" onclick="generateReport()">
                        <i class="fas fa-file-alt"></i> ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- åˆ†æã‚¿ãƒ– -->
        <div class="analysis-tabs">
            <ul class="nav nav-tabs" id="analysisTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="efficiency-tab" data-toggle="tab" href="#efficiency" role="tab">
                        <i class="fas fa-tachometer-alt"></i> åŠ¹ç‡åˆ†æ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="trends-tab" data-toggle="tab" href="#trends" role="tab">
                        <i class="fas fa-chart-line"></i> ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="comparison-tab" data-toggle="tab" href="#comparison" role="tab">
                        <i class="fas fa-balance-scale"></i> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯”è¼ƒ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="quality-tab" data-toggle="tab" href="#quality" role="tab">
                        <i class="fas fa-check-circle"></i> å“è³ªåˆ†æ
                    </a>
                </li>
            </ul>
            
            <div class="tab-content" id="analysisTabContent">
                <!-- åŠ¹ç‡åˆ†æã‚¿ãƒ– -->
                <div class="tab-pane fade show active" id="efficiency" role="tabpanel">
                    <h5 class="section-title">
                        <i class="fas fa-tachometer-alt"></i> CO2é™¤å»åŠ¹ç‡åˆ†æ
                    </h5>
                    
                    <!-- åŠ¹ç‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
                    <div class="efficiency-grid" id="efficiencyMetrics">
                        <div class="efficiency-card">
                            <div class="efficiency-percentage" id="averageEfficiency">-</div>
                            <div class="efficiency-label">å¹³å‡åŠ¹ç‡</div>
                            <div class="trend-indicator" id="efficiencyTrend">
                                <i class="fas fa-minus"></i> ãƒ‡ãƒ¼ã‚¿ä¸è¶³
                            </div>
                        </div>
                        <div class="efficiency-card">
                            <div class="efficiency-percentage" id="maxEfficiency">-</div>
                            <div class="efficiency-label">æœ€å¤§åŠ¹ç‡</div>
                        </div>
                        <div class="efficiency-card">
                            <div class="efficiency-percentage" id="targetProgress">-</div>
                            <div class="efficiency-label">ç›®æ¨™é”æˆç‡</div>
                        </div>
                        <div class="efficiency-card">
                            <div class="efficiency-percentage" id="totalCO2Removed">-</div>
                            <div class="efficiency-label">ç·CO2é™¤å»é‡ (kg)</div>
                        </div>
                    </div>
                    
                    <!-- ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ¯”è¼ƒ -->
                    <div class="benchmark-comparison" id="benchmarkComparison">
                        <h6><i class="fas fa-chart-bar"></i> æ¥­ç•Œãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ¯”è¼ƒ</h6>
                        <div class="comparison-item">
                            <span>åŠ¹ç‡ vs æ¥­ç•Œå¹³å‡:</span>
                            <span id="efficiencyVsBenchmark">-</span>
                        </div>
                        <div class="comparison-item">
                            <span>CO2é™¤å»é‡ vs æ¥­ç•Œå¹³å‡:</span>
                            <span id="co2VsBenchmark">-</span>
                        </div>
                        <div class="comparison-item">
                            <span>å“è³ªã‚¹ã‚³ã‚¢ vs æ¥­ç•Œå¹³å‡:</span>
                            <span id="qualityVsBenchmark">-</span>
                        </div>
                    </div>
                    
                    <!-- åŠ¹ç‡ãƒãƒ£ãƒ¼ãƒˆ -->
                    <div class="chart-container">
                        <h6><i class="fas fa-chart-area"></i> åŠ¹ç‡æ¨ç§»</h6>
                        <div class="chart-placeholder" id="efficiencyChart">
                            <i class="fas fa-chart-area"></i>
                            <div>åŠ¹ç‡æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆã¯Chart.jsã§å®Ÿè£…äºˆå®š</div>
                            <small class="text-muted">åˆ†æã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</small>
                        </div>
                    </div>
                    
                    <!-- æ¨å¥¨äº‹é … -->
                    <div id="efficiencyRecommendations">
                        <h6><i class="fas fa-lightbulb"></i> æ¨å¥¨äº‹é …</h6>
                        <div id="recommendationsList">
                            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                
                <!-- ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚¿ãƒ– -->
                <div class="tab-pane fade" id="trends" role="tabpanel">
                    <h5 class="section-title">
                        <i class="fas fa-chart-line"></i> ç’°å¢ƒãƒ‡ãƒ¼ã‚¿ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <!-- ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆ -->
                            <div class="chart-container">
                                <h6 id="trendChartTitle"><i class="fas fa-chart-line"></i> CO2æ¿ƒåº¦ãƒˆãƒ¬ãƒ³ãƒ‰</h6>
                                <div class="chart-placeholder" id="trendChart">
                                    <i class="fas fa-chart-line"></i>
                                    <div>ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆã¯Chart.jsã§å®Ÿè£…äºˆå®š</div>
                                    <small class="text-muted">åˆ†æã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- ãƒˆãƒ¬ãƒ³ãƒ‰çµ±è¨ˆ -->
                            <div class="analysis-section">
                                <h6><i class="fas fa-calculator"></i> çµ±è¨ˆæƒ…å ±</h6>
                                <div class="metric-card">
                                    <div class="metric-value" id="trendAverage">-</div>
                                    <div class="metric-label">å¹³å‡å€¤</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" id="trendStdDev">-</div>
                                    <div class="metric-label">æ¨™æº–åå·®</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" id="trendVariation">-</div>
                                    <div class="metric-label">å¤‰å‹•ä¿‚æ•°</div>
                                </div>
                            </div>
                            
                            <!-- ç•°å¸¸å€¤æ¤œçŸ¥ -->
                            <div class="analysis-section">
                                <h6><i class="fas fa-exclamation-triangle"></i> ç•°å¸¸å€¤</h6>
                                <div id="anomaliesList">
                                    <p class="text-muted">åˆ†æã‚’å®Ÿè¡Œã—ã¦ç•°å¸¸å€¤ã‚’æ¤œå‡º</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- äºˆæ¸¬ -->
                    <div class="chart-container">
                        <h6><i class="fas fa-crystal-ball"></i> 30æ—¥äºˆæ¸¬</h6>
                        <div class="chart-placeholder" id="forecastChart">
                            <i class="fas fa-crystal-ball"></i>
                            <div>äºˆæ¸¬ãƒãƒ£ãƒ¼ãƒˆã¯Chart.jsã§å®Ÿè£…äºˆå®š</div>
                            <small class="text-muted">åˆ†æã‚’å®Ÿè¡Œã—ã¦äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</small>
                        </div>
                    </div>
                </div>
                
                <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯”è¼ƒã‚¿ãƒ– -->
                <div class="tab-pane fade" id="comparison" role="tabpanel">
                    <h5 class="section-title">
                        <i class="fas fa-balance-scale"></i> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯”è¼ƒåˆ†æ
                    </h5>
                    
                    <!-- æ¯”è¼ƒå¯¾è±¡é¸æŠ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="comparisonProjects">æ¯”è¼ƒå¯¾è±¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆè¤‡æ•°é¸æŠï¼‰</label>
                            <select class="form-control" id="comparisonProjects" multiple size="5">
                                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                            </select>
                            <small class="form-text text-muted">Ctrlã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠ</small>
                        </div>
                        <div class="col-md-3">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary btn-block" onclick="runComparison()">
                                <i class="fas fa-balance-scale"></i> æ¯”è¼ƒå®Ÿè¡Œ
                            </button>
                        </div>
                    </div>
                    
                    <!-- æ¯”è¼ƒçµæœ -->
                    <div id="comparisonResults" style="display: none;">
                        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                        <div class="analysis-section">
                            <h6><i class="fas fa-trophy"></i> åŠ¹ç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h6>
                            <div id="efficiencyRanking">
                                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                            </div>
                        </div>
                        
                        <!-- æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ -->
                        <div class="chart-container">
                            <h6><i class="fas fa-chart-bar"></i> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯”è¼ƒ</h6>
                            <div class="chart-placeholder" id="comparisonChart">
                                <i class="fas fa-chart-bar"></i>
                                <div>æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆã¯Chart.jsã§å®Ÿè£…äºˆå®š</div>
                                <small class="text-muted">æ¯”è¼ƒã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å“è³ªåˆ†æã‚¿ãƒ– -->
                <div class="tab-pane fade" id="quality" role="tabpanel">
                    <h5 class="section-title">
                        <i class="fas fa-check-circle"></i> ãƒ‡ãƒ¼ã‚¿å“è³ªåˆ†æ
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <!-- å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
                            <div class="analysis-section">
                                <h6><i class="fas fa-clipboard-check"></i> å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹</h6>
                                <div class="metric-card">
                                    <div class="metric-value" id="qualityScore">-</div>
                                    <div class="metric-label">å¹³å‡å“è³ªã‚¹ã‚³ã‚¢</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" id="qualityGradeA">-</div>
                                    <div class="metric-label">Aã‚°ãƒ¬ãƒ¼ãƒ‰ç‡ (%)</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" id="alertCount">-</div>
                                    <div class="metric-label">ã‚¢ãƒ©ãƒ¼ãƒˆæ•°</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- å“è³ªåˆ†å¸ƒ -->
                            <div class="chart-container">
                                <h6><i class="fas fa-chart-pie"></i> å“è³ªã‚°ãƒ¬ãƒ¼ãƒ‰åˆ†å¸ƒ</h6>
                                <div class="chart-placeholder" id="qualityDistribution">
                                    <i class="fas fa-chart-pie"></i>
                                    <div>å“è³ªåˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆã¯Chart.jsã§å®Ÿè£…äºˆå®š</div>
                                    <small class="text-muted">åˆ†æã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè©³ç´° -->
                    <div class="analysis-section">
                        <h6><i class="fas fa-exclamation-circle"></i> ã‚¢ãƒ©ãƒ¼ãƒˆè©³ç´°</h6>
                        <div id="alertDetails">
                            <p class="text-muted">åˆ†æã‚’å®Ÿè¡Œã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆè©³ç´°ã‚’è¡¨ç¤º</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap 4 JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let projects = [];
        let currentAnalysisData = null;
        
        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });
        
        function initializePage() {
            console.log('åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ä¸­...');
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            loadProjects();
            
            // ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆåˆæœŸè¡¨ç¤ºç”¨ï¼‰
            generateSystemReport();
        }
        
        function loadProjects() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        projects = result.data;
                        populateProjectSelects();
                    } else {
                        console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', result.message);
                        showAlert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—:', error);
                    showAlert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                })
                .loadProjectsData();
        }
        
        function populateProjectSelects() {
            const selects = ['#analysisProject', '#comparisonProjects'];
            
            selects.forEach(selector => {
                const select = $(selector);
                const currentValue = select.val();
                
                // æœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»¥å¤–ã‚’ã‚¯ãƒªã‚¢
                select.find('option:not(:first)').remove();
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                projects.forEach(project => {
                    const option = $('<option>', {
                        value: project.projectId,
                        text: `${project.projectName} (${project.customerName})`
                    });
                    select.append(option);
                });
                
                // å‰ã®å€¤ãŒã‚ã‚Œã°å¾©å…ƒ
                if (currentValue) {
                    select.val(currentValue);
                }
            });
        }
        
        function runAnalysis() {
            const projectId = $('#analysisProject').val();
            const period = $('#analysisPeriod').val();
            
            if (!projectId) {
                showAlert('åˆ†æå¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            showLoading('åŠ¹ç‡åˆ†æã‚’å®Ÿè¡Œä¸­...');
            
            // CO2é™¤å»åŠ¹ç‡åˆ†æã‚’å®Ÿè¡Œ
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        currentAnalysisData = result.data;
                        updateEfficiencyDisplay(result.data);
                        showAlert('åŠ¹ç‡åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                    } else {
                        showAlert('åŠ¹ç‡åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message, 'danger');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showAlert('åŠ¹ç‡åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                    console.error('Analysis error:', error);
                })
                .getCO2RemovalEfficiency(projectId, period);
                
            // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚‚å®Ÿè¡Œ
            const metric = $('#analysisMetric').val();
            runTrendAnalysis(projectId, metric, period);
        }
        
        function runTrendAnalysis(projectId, metric, period) {
            showLoading('ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚’å®Ÿè¡Œä¸­...');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        updateTrendDisplay(result.data, metric);
                    } else {
                        console.error('ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚¨ãƒ©ãƒ¼:', result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    console.error('Trend analysis error:', error);
                })
                .analyzeEnvironmentalTrends(projectId, metric, { period: period });
        }
        
        function updateEfficiencyDisplay(data) {
            // åŠ¹ç‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ›´æ–°
            $('#averageEfficiency').text(data.efficiency.averageEfficiency + '%');
            $('#maxEfficiency').text(data.efficiency.maxEfficiency + '%');
            $('#targetProgress').text(data.efficiency.targetProgress + '%');
            $('#totalCO2Removed').text(data.efficiency.totalCO2Removed.toLocaleString());
            
            // ãƒˆãƒ¬ãƒ³ãƒ‰æŒ‡æ¨™ã‚’æ›´æ–°
            updateTrendIndicator('#efficiencyTrend', data.trends.efficiencyTrend);
            
            // ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ¯”è¼ƒã‚’æ›´æ–°
            if (data.comparison) {
                const efficiencyDiff = data.comparison.efficiencyVsBenchmark;
                const co2Diff = data.comparison.co2RemovalVsBenchmark;
                const qualityDiff = data.comparison.qualityVsBenchmark;
                
                $('#efficiencyVsBenchmark').text(formatPercentageDiff(efficiencyDiff));
                $('#co2VsBenchmark').text(formatPercentageDiff(co2Diff));
                $('#qualityVsBenchmark').text(formatPercentageDiff(qualityDiff));
                
                // è‰²åˆ†ã‘
                updateComparisonColor('#efficiencyVsBenchmark', efficiencyDiff);
                updateComparisonColor('#co2VsBenchmark', co2Diff);
                updateComparisonColor('#qualityVsBenchmark', qualityDiff);
            }
            
            // æ¨å¥¨äº‹é …ã‚’æ›´æ–°
            if (data.analysis && data.analysis.recommendations) {
                updateRecommendations(data.analysis.recommendations);
            }
        }
        
        function updateTrendDisplay(data, metric) {
            // ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const metricNames = {
                'co2': 'CO2æ¿ƒåº¦',
                'ph': 'pHå€¤',
                'temperature': 'æ¸©åº¦',
                'flowRate': 'æµé‡',
                'removal': 'CO2é™¤å»é‡'
            };
            
            $('#trendChartTitle').html(`<i class="fas fa-chart-line"></i> ${metricNames[metric]}ãƒˆãƒ¬ãƒ³ãƒ‰`);
            
            // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
            if (data.statistics) {
                $('#trendAverage').text(data.statistics.mean ? data.statistics.mean.toFixed(2) : '-');
                $('#trendStdDev').text(data.statistics.standardDeviation ? data.statistics.standardDeviation.toFixed(2) : '-');
                $('#trendVariation').text(data.statistics.coefficientOfVariation ? 
                    (data.statistics.coefficientOfVariation * 100).toFixed(1) + '%' : '-');
            }
            
            // ç•°å¸¸å€¤ã‚’æ›´æ–°
            if (data.anomalies && data.anomalies.length > 0) {
                updateAnomaliesList(data.anomalies);
            } else {
                $('#anomaliesList').html('<p class="text-muted">ç•°å¸¸å€¤ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</p>');
            }
        }
        
        function updateTrendIndicator(selector, trend) {
            const element = $(selector);
            element.removeClass('trend-up trend-down trend-stable');
            
            switch (trend) {
                case 'improving':
                    element.addClass('trend-up');
                    element.html('<i class="fas fa-arrow-up"></i> æ”¹å–„å‚¾å‘');
                    break;
                case 'declining':
                    element.addClass('trend-down');
                    element.html('<i class="fas fa-arrow-down"></i> ä½ä¸‹å‚¾å‘');
                    break;
                case 'stable':
                    element.addClass('trend-stable');
                    element.html('<i class="fas fa-minus"></i> å®‰å®š');
                    break;
                default:
                    element.addClass('trend-stable');
                    element.html('<i class="fas fa-minus"></i> ãƒ‡ãƒ¼ã‚¿ä¸è¶³');
            }
        }
        
        function formatPercentageDiff(diff) {
            if (diff === null || diff === undefined) return '-';
            
            const sign = diff > 0 ? '+' : '';
            return sign + diff.toFixed(1) + '%';
        }
        
        function updateComparisonColor(selector, value) {
            const element = $(selector);
            element.removeClass('text-success text-danger text-warning');
            
            if (value > 5) {
                element.addClass('text-success');
            } else if (value < -5) {
                element.addClass('text-danger');
            } else {
                element.addClass('text-warning');
            }
        }
        
        function updateRecommendations(recommendations) {
            const container = $('#recommendationsList');
            container.empty();
            
            if (recommendations.length === 0) {
                container.html('<p class="text-muted">ç¾åœ¨ã€ç‰¹åˆ¥ãªæ¨å¥¨äº‹é …ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>');
                return;
            }
            
            recommendations.forEach(rec => {
                const priorityClass = rec.priority === 'high' ? 'high-priority' : 
                                    rec.priority === 'medium' ? 'medium-priority' : '';
                
                const card = $(`
                    <div class="recommendation-card ${priorityClass}">
                        <div class="recommendation-title">${rec.title}</div>
                        <p class="recommendation-desc">${rec.description}</p>
                    </div>
                `);
                
                container.append(card);
            });
        }
        
        function updateAnomaliesList(anomalies) {
            const container = $('#anomaliesList');
            container.empty();
            
            anomalies.slice(0, 5).forEach(anomaly => { // æœ€å¤§5ä»¶è¡¨ç¤º
                const item = $(`
                    <div class="alert alert-warning" role="alert">
                        <small>
                            <strong>${anomaly.date}</strong><br>
                            å€¤: ${anomaly.value}<br>
                            ${anomaly.description || 'ç•°å¸¸å€¤ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ'}
                        </small>
                    </div>
                `);
                
                container.append(item);
            });
            
            if (anomalies.length > 5) {
                container.append(`<p class="text-muted">ä»– ${anomalies.length - 5} ä»¶ã®ç•°å¸¸å€¤</p>`);
            }
        }
        
        function runComparison() {
            const selectedProjects = $('#comparisonProjects').val();
            
            if (!selectedProjects || selectedProjects.length < 2) {
                showAlert('æ¯”è¼ƒã«ã¯2ã¤ä»¥ä¸Šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            showLoading('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯”è¼ƒã‚’å®Ÿè¡Œä¸­...');
            
            const period = $('#analysisPeriod').val();
            
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        updateComparisonDisplay(result.data);
                        $('#comparisonResults').show();
                        showAlert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯”è¼ƒãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                    } else {
                        showAlert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯”è¼ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message, 'danger');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showAlert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¯”è¼ƒä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                    console.error('Comparison error:', error);
                })
                .compareProjects(selectedProjects, period);
        }
        
        function updateComparisonDisplay(data) {
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
            if (data.rankings) {
                updateEfficiencyRanking(data.rankings);
            }
        }
        
        function updateEfficiencyRanking(rankings) {
            const container = $('#efficiencyRanking');
            container.empty();
            
            rankings.efficiency.forEach((item, index) => {
                const project = projects.find(p => p.projectId === item.projectId);
                const projectName = project ? project.projectName : item.projectId;
                
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : (index + 1);
                
                const rankItem = $(`
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${medal} ${projectName}</span>
                        <span class="font-weight-bold">${item.value.toFixed(1)}%</span>
                    </div>
                `);
                
                container.append(rankItem);
            });
        }
        
        function generateSystemReport() {
            showLoading('ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...');
            
            const period = $('#analysisPeriod').val();
            
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        updateSystemReportDisplay(result.data);
                        showAlert('ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ', 'success');
                    } else {
                        showAlert('ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message, 'danger');
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showAlert('ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                    console.error('System report error:', error);
                })
                .generateSystemReport({ period: period });
        }
        
        function updateSystemReportDisplay(data) {
            // ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆã‚’è¡¨ç¤º
            if (data.systemStats) {
                console.log('ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ:', data.systemStats);
            }
            
            // å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¡¨ç¤º
            if (data.qualityMetrics) {
                $('#qualityScore').text(data.qualityMetrics.averageScore || '-');
                $('#qualityGradeA').text(data.qualityMetrics.gradeAPercentage || '-');
                $('#alertCount').text(data.qualityMetrics.totalAlerts || '-');
            }
        }
        
        function showLoading(message = 'å‡¦ç†ä¸­...') {
            // æ—¢å­˜ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å‰Šé™¤
            $('.loading-overlay').remove();
            
            const overlay = $(`
                <div class="loading-overlay">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <div>${message}</div>
                    </div>
                </div>
            `);
            
            $('.analysis-section').first().css('position', 'relative').append(overlay);
        }
        
        function hideLoading() {
            $('.loading-overlay').remove();
        }
        
        function showAlert(message, type = 'info') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            `;
            
            $('.container').first().prepend(alertHtml);
            
            // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 5000);
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                window.location.href = '?';
            }
        }
        
        function exportAnalysis() {
            if (!currentAnalysisData) {
                showAlert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšåˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', 'warning');
                return;
            }
            
            // åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’JSONã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
            const dataStr = JSON.stringify(currentAnalysisData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `analysis_${new Date().getTime()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showAlert('åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }
        
        function generateReport() {
            generateSystemReport();
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å‡¦ç†
        $('#analysisTab a').on('click', function (e) {
            e.preventDefault();
            $(this).tab('show');
        });
        
        // åˆ†æãƒ¡ãƒˆãƒªãƒƒã‚¯å¤‰æ›´æ™‚ã®å‡¦ç†
        $('#analysisMetric').on('change', function() {
            const projectId = $('#analysisProject').val();
            const period = $('#analysisPeriod').val();
            const metric = $(this).val();
            
            if (projectId) {
                runTrendAnalysis(projectId, metric, period);
            }
        });
    </script>
</body>
</html>