<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= appName ?> - プロジェクト管理</title>
    
    <!-- Bootstrap 4 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            color: white !important;
            font-weight: 700;
            font-size: 1.3rem;
        }
        
        .navbar-text {
            color: rgba(255,255,255,0.9) !important;
        }
        
        .btn-outline-light {
            border-color: rgba(255,255,255,0.5);
            color: white;
        }
        
        .btn-outline-light:hover {
            background-color: rgba(255,255,255,0.2);
            border-color: white;
            color: white;
        }
        
        .main-container {
            padding: 30px 0;
        }
        
        .page-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .page-title {
            color: #333;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .page-title i {
            margin-right: 15px;
            color: #f093fb;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .stats-row {
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
            height: 100%;
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin: 0 auto 15px;
        }
        
        .stat-icon.total {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .stat-icon.active {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .stat-icon.progress {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .stat-icon.co2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }
        
        .action-bar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-section {
            display: flex;
            gap: 15px;
            flex: 1;
            margin-right: 20px;
        }
        
        .search-input {
            border-radius: 10px;
            border: 1px solid #ddd;
            padding: 10px 15px;
            min-width: 250px;
        }
        
        .filter-select {
            border-radius: 10px;
            border: 1px solid #ddd;
            padding: 10px 15px;
            min-width: 150px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .projects-table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead th {
            border-top: none;
            border-bottom: 2px solid #dee2e6;
            color: #495057;
            font-weight: 600;
            padding: 15px 10px;
        }
        
        .table tbody td {
            border-top: 1px solid #f0f0f0;
            padding: 15px 10px;
            vertical-align: middle;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .project-name {
            font-weight: 600;
            color: #333;
        }
        
        .customer-name {
            color: #666;
            font-size: 0.9rem;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.planning {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-badge.active {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-badge.on-hold {
            background: #fff8e1;
            color: #f57c00;
        }
        
        .status-badge.completed {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-badge.cancelled {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .progress-bar-container {
            width: 100px;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: #495057;
            z-index: 1;
        }
        
        .co2-amount {
            font-weight: 600;
            color: #495057;
        }
        
        .co2-target {
            color: #666;
            font-size: 0.9rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 6px;
        }
        
        .btn-info {
            background: #17a2b8;
            border-color: #17a2b8;
        }
        
        .btn-warning {
            background: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }
        
        .btn-danger {
            background: #dc3545;
            border-color: #dc3545;
        }
        
        .pagination-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .pagination {
            margin: 0;
            justify-content: center;
        }
        
        .page-link {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            color: #495057;
            margin: 0 2px;
        }
        
        .page-link:hover {
            background-color: #f093fb;
            color: white;
            border-color: #f093fb;
        }
        
        .page-item.active .page-link {
            background-color: #f093fb;
            border-color: #f093fb;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .modal-title {
            font-weight: 600;
        }
        
        .form-group label {
            font-weight: 600;
            color: #495057;
        }
        
        .form-control {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 12px;
        }
        
        .form-control:focus {
            border-color: #f093fb;
            box-shadow: 0 0 0 0.2rem rgba(240, 147, 251, 0.25);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .alert-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9998;
            max-width: 400px;
        }
        
        @media (max-width: 768px) {
            .action-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-section {
                margin-right: 0;
                margin-bottom: 15px;
                flex-direction: column;
            }
            
            .search-input,
            .filter-select {
                min-width: auto;
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .table-responsive {
                border: none;
            }
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="?page=admin-dashboard">
                <i class="fas fa-leaf"></i> <?= appName ?>
            </a>
            
            <div class="navbar-nav ml-auto">
                <span class="navbar-text mr-3">
                    <i class="fas fa-user-shield"></i> 管理者: <?= user.name ?>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> ダッシュボード
                </button>
            </div>
        </div>
    </nav>
    
    <!-- メインコンテンツ -->
    <div class="main-container">
        <div class="container">
            <!-- ページヘッダー -->
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-project-diagram"></i> プロジェクト管理
                </h1>
                <p class="page-subtitle">
                    風化促進CO2除去プロジェクトの管理・追跡・分析を行います
                </p>
            </div>
            
            <!-- 統計サマリー -->
            <div class="row stats-row">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon total">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div class="stat-number" id="totalProjects"><?= stats.total || 0 ?></div>
                        <p class="stat-label">総プロジェクト数</p>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon active">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="stat-number" id="activeProjects"><?= stats.active || 0 ?></div>
                        <p class="stat-label">進行中プロジェクト</p>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon progress">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-number" id="averageProgress"><?= stats.averageProgress || 0 ?>%</div>
                        <p class="stat-label">平均進捗率</p>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-icon co2">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-number" id="totalCO2"><?= stats.totalCO2Actual || 0 ?></div>
                        <p class="stat-label">CO2除去量（トン）</p>
                    </div>
                </div>
            </div>
            
            <!-- アクション バー -->
            <div class="action-bar">
                <div class="search-section">
                    <input type="text" class="form-control search-input" id="searchInput" 
                           placeholder="プロジェクト名・顧客名・場所で検索...">
                    
                    <select class="form-control filter-select" id="statusFilter">
                        <option value="">全てのステータス</option>
                        <option value="planning">計画中</option>
                        <option value="active">進行中</option>
                        <option value="on-hold">一時停止</option>
                        <option value="completed">完了</option>
                        <option value="cancelled">キャンセル</option>
                    </select>
                    
                    <select class="form-control filter-select" id="customerFilter">
                        <option value="">全ての顧客</option>
                        <!-- 顧客オプションは JavaScript で動的に追加 -->
                    </select>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="openCreateModal()">
                        <i class="fas fa-plus"></i> 新規プロジェクト
                    </button>
                    
                    <button class="btn btn-primary" onclick="refreshProjects()">
                        <i class="fas fa-sync-alt"></i> 更新
                    </button>
                </div>
            </div>
            
            <!-- プロジェクト一覧テーブル -->
            <div class="projects-table-container">
                <div class="table-responsive">
                    <table class="table" id="projectsTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('projectName')">
                                    プロジェクト名 <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('customerName')">
                                    顧客 <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('location')">
                                    場所 <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('status')">
                                    ステータス <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('progress')">
                                    進捗率 <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('targetCO2Removal')">
                                    CO2除去量 <i class="fas fa-sort"></i>
                                </th>
                                <th onclick="sortTable('startDate')">
                                    開始日 <i class="fas fa-sort"></i>
                                </th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <!-- データは JavaScript で動的に挿入 -->
                        </tbody>
                    </table>
                </div>
                
                <!-- データなしの場合の表示 -->
                <div id="noDataMessage" class="text-center py-5" style="display: none;">
                    <i class="fas fa-project-diagram text-muted" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <h5 class="text-muted">プロジェクトデータが見つかりません</h5>
                    <p class="text-muted">検索条件を変更するか、新規プロジェクトを作成してください。</p>
                </div>
            </div>
            
            <!-- ページネーション -->
            <div class="pagination-container">
                <nav>
                    <ul class="pagination" id="pagination">
                        <!-- ページネーションは JavaScript で動的に生成 -->
                    </ul>
                </nav>
                
                <div class="mt-3">
                    <small class="text-muted" id="paginationInfo">
                        <!-- ページ情報は JavaScript で動的に表示 -->
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- プロジェクト作成・編集モーダル -->
    <div class="modal fade" id="projectModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">新規プロジェクト作成</h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="projectForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="projectName">プロジェクト名 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="projectName" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="customerId">顧客 <span class="text-danger">*</span></label>
                                    <select class="form-control" id="customerId" required>
                                        <option value="">顧客を選択してください</option>
                                        <!-- 顧客オプションは JavaScript で動的に追加 -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">プロジェクト説明</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="location">場所</label>
                                    <input type="text" class="form-control" id="location">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="status">ステータス</label>
                                    <select class="form-control" id="status">
                                        <option value="planning">計画中</option>
                                        <option value="active">進行中</option>
                                        <option value="on-hold">一時停止</option>
                                        <option value="completed">完了</option>
                                        <option value="cancelled">キャンセル</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="startDate">開始日 <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="startDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="endDate">終了予定日</label>
                                    <input type="date" class="form-control" id="endDate">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="targetCO2Removal">目標CO2除去量（トン/年）</label>
                                    <input type="number" class="form-control" id="targetCO2Removal" min="0" step="0.1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="actualCO2Removal">実際CO2除去量（トン）</label>
                                    <input type="number" class="form-control" id="actualCO2Removal" min="0" step="0.1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="notes">備考</label>
                            <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>
                        
                        <input type="hidden" id="projectId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="saveProject()">
                        <i class="fas fa-save"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ローディングオーバーレイ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <div class="mt-3">処理中...</div>
        </div>
    </div>
    
    <!-- アラート表示エリア -->
    <div class="alert-container" id="alertContainer"></div>
    
    <!-- Bootstrap 4 JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // グローバル変数
        let allProjects = [];
        let allCustomers = [];
        let filteredProjects = [];
        let currentPage = 1;
        let pageSize = 10;
        let sortColumn = 'createdAt';
        let sortDirection = 'desc';
        let isEditMode = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Projects management page loaded');
            initializePage();
        });
        
        // ページ初期化
        function initializePage() {
            setupEventListeners();
            loadInitialData();
        }
        
        // イベントリスナー設定
        function setupEventListeners() {
            // 検索フィルタ
            document.getElementById('searchInput').addEventListener('input', debounce(filterProjects, 300));
            document.getElementById('statusFilter').addEventListener('change', filterProjects);
            document.getElementById('customerFilter').addEventListener('change', filterProjects);
            
            // モーダルイベント
            $('#projectModal').on('hidden.bs.modal', function() {
                resetForm();
            });
        }
        
        // 初期データを読み込む
        function loadInitialData() {
            showLoading(true);
            
            // 顧客データとプロジェクトデータを並行して読み込み
            Promise.all([
                loadCustomers(),
                loadProjects()
            ]).then(() => {
                showLoading(false);
            }).catch(error => {
                console.error('Failed to load initial data:', error);
                showAlert('エラー', '初期データの読み込みに失敗しました', 'error');
                showLoading(false);
            });
        }
        
        // 顧客データを読み込む
        function loadCustomers() {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            allCustomers = result.data;
                            populateCustomerFilters();
                            resolve(result);
                        } else {
                            reject(new Error(result.message));
                        }
                    })
                    .withFailureHandler(reject)
                    .loadCustomersData();
            });
        }
        
        // プロジェクトデータを読み込む
        function loadProjects() {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            allProjects = result.data;
                            updateStats(result.stats);
                            filterProjects();
                            resolve(result);
                        } else {
                            reject(new Error(result.message));
                        }
                    })
                    .withFailureHandler(reject)
                    .loadProjectsData();
            });
        }
        
        // 顧客フィルタを設定
        function populateCustomerFilters() {
            const customerFilter = document.getElementById('customerFilter');
            const customerSelect = document.getElementById('customerId');
            
            // フィルタオプション
            customerFilter.innerHTML = '<option value="">全ての顧客</option>';
            allCustomers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.customerId;
                option.textContent = customer.companyName;
                customerFilter.appendChild(option);
            });
            
            // モーダル用顧客選択
            customerSelect.innerHTML = '<option value="">顧客を選択してください</option>';
            allCustomers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.customerId;
                option.textContent = customer.companyName;
                customerSelect.appendChild(option);
            });
        }
        
        // 統計情報を更新
        function updateStats(stats) {
            if (stats) {
                document.getElementById('totalProjects').textContent = stats.total || 0;
                document.getElementById('activeProjects').textContent = stats.active || 0;
                document.getElementById('averageProgress').textContent = (stats.averageProgress || 0) + '%';
                document.getElementById('totalCO2').textContent = stats.totalCO2Actual || 0;
            }
        }
        
        // プロジェクトデータをフィルタリング
        function filterProjects() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const customerFilter = document.getElementById('customerFilter').value;
            
            filteredProjects = allProjects.filter(project => {
                const matchesSearch = !searchTerm || 
                    project.projectName.toLowerCase().includes(searchTerm) ||
                    project.customerName.toLowerCase().includes(searchTerm) ||
                    project.location.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || project.status === statusFilter;
                const matchesCustomer = !customerFilter || project.customerId === customerFilter;
                
                return matchesSearch && matchesStatus && matchesCustomer;
            });
            
            currentPage = 1;
            renderProjectsTable();
            renderPagination();
        }
        
        // プロジェクトテーブルをレンダリング
        function renderProjectsTable() {
            const tableBody = document.getElementById('projectsTableBody');
            const noDataMessage = document.getElementById('noDataMessage');
            
            if (filteredProjects.length === 0) {
                tableBody.innerHTML = '';
                noDataMessage.style.display = 'block';
                return;
            }
            
            noDataMessage.style.display = 'none';
            
            // ソート
            const sortedProjects = [...filteredProjects].sort((a, b) => {
                let valueA = a[sortColumn];
                let valueB = b[sortColumn];
                
                if (sortColumn === 'startDate' || sortColumn === 'endDate' || sortColumn === 'createdAt') {
                    valueA = new Date(valueA);
                    valueB = new Date(valueB);
                } else if (sortColumn === 'targetCO2Removal' || sortColumn === 'actualCO2Removal' || sortColumn === 'progress') {
                    valueA = parseFloat(valueA) || 0;
                    valueB = parseFloat(valueB) || 0;
                } else if (typeof valueA === 'string') {
                    valueA = valueA.toLowerCase();
                    valueB = valueB.toLowerCase();
                }
                
                if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            // ページネーション
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageProjects = sortedProjects.slice(startIndex, endIndex);
            
            // テーブル行生成
            const rows = pageProjects.map(project => `
                <tr>
                    <td>
                        <div class="project-name">${escapeHtml(project.projectName)}</div>
                        <div class="customer-name">${escapeHtml(project.customerName)}</div>
                    </td>
                    <td>${escapeHtml(project.customerName)}</td>
                    <td>${escapeHtml(project.location)}</td>
                    <td>
                        <span class="status-badge ${project.status}">
                            ${getStatusLabel(project.status)}
                        </span>
                    </td>
                    <td>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${project.progress || 0}%"></div>
                            <div class="progress-text">${project.progress || 0}%</div>
                        </div>
                    </td>
                    <td>
                        <div class="co2-amount">${formatNumber(project.actualCO2Removal || 0)} トン</div>
                        <div class="co2-target">/ ${formatNumber(project.targetCO2Removal || 0)} トン</div>
                    </td>
                    <td>${formatDate(project.startDate)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="viewProject('${project.projectId}')" 
                                    title="詳細表示">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editProject('${project.projectId}')" 
                                    title="編集">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProject('${project.projectId}')" 
                                    title="削除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            tableBody.innerHTML = rows;
        }
        
        // ページネーションをレンダリング
        function renderPagination() {
            const totalPages = Math.ceil(filteredProjects.length / pageSize);
            const pagination = document.getElementById('pagination');
            const paginationInfo = document.getElementById('paginationInfo');
            
            // ページ情報表示
            const startItem = (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(currentPage * pageSize, filteredProjects.length);
            paginationInfo.textContent = `${startItem}-${endItem} / ${filteredProjects.length}件`;
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // 前へボタン
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">前へ</a>
                </li>
            `;
            
            // ページ番号
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }
            
            // 次へボタン
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">次へ</a>
                </li>
            `;
            
            pagination.innerHTML = paginationHTML;
        }
        
        // ページ変更
        function changePage(page) {
            const totalPages = Math.ceil(filteredProjects.length / pageSize);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderProjectsTable();
            renderPagination();
        }
        
        // テーブルソート
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            renderProjectsTable();
            renderPagination();
        }
        
        // 新規プロジェクト作成モーダルを開く
        function openCreateModal() {
            if (allCustomers.length === 0) {
                showAlert('エラー', '先に顧客を登録してください', 'warning');
                return;
            }
            
            isEditMode = false;
            document.getElementById('modalTitle').textContent = '新規プロジェクト作成';
            resetForm();
            // デフォルト値設定
            document.getElementById('startDate').value = new Date().toISOString().split('T')[0];
            $('#projectModal').modal('show');
        }
        
        // プロジェクト編集モーダルを開く
        function editProject(projectId) {
            const project = allProjects.find(p => p.projectId === projectId);
            if (!project) {
                showAlert('エラー', 'プロジェクトが見つかりません', 'error');
                return;
            }
            
            isEditMode = true;
            document.getElementById('modalTitle').textContent = 'プロジェクト編集';
            
            // フォームにデータ設定
            document.getElementById('projectId').value = project.projectId;
            document.getElementById('projectName').value = project.projectName;
            document.getElementById('customerId').value = project.customerId;
            document.getElementById('description').value = project.description;
            document.getElementById('location').value = project.location;
            document.getElementById('status').value = project.status;
            document.getElementById('startDate').value = formatDateForInput(project.startDate);
            document.getElementById('endDate').value = formatDateForInput(project.endDate);
            document.getElementById('targetCO2Removal').value = project.targetCO2Removal;
            document.getElementById('actualCO2Removal').value = project.actualCO2Removal;
            document.getElementById('notes').value = project.notes;
            
            $('#projectModal').modal('show');
        }
        
        // プロジェクト詳細表示
        function viewProject(projectId) {
            const project = allProjects.find(p => p.projectId === projectId);
            if (!project) {
                showAlert('エラー', 'プロジェクトが見つかりません', 'error');
                return;
            }
            
            const detailHTML = `
                <div class="project-detail">
                    <h5>${escapeHtml(project.projectName)}</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>顧客:</strong> ${escapeHtml(project.customerName)}</p>
                            <p><strong>場所:</strong> ${escapeHtml(project.location)}</p>
                            <p><strong>ステータス:</strong> ${getStatusLabel(project.status)}</p>
                            <p><strong>進捗率:</strong> ${project.progress || 0}%</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>開始日:</strong> ${formatDate(project.startDate)}</p>
                            <p><strong>終了予定日:</strong> ${formatDate(project.endDate)}</p>
                            <p><strong>目標CO2除去量:</strong> ${formatNumber(project.targetCO2Removal)} トン/年</p>
                            <p><strong>実際CO2除去量:</strong> ${formatNumber(project.actualCO2Removal)} トン</p>
                        </div>
                    </div>
                    <p><strong>プロジェクト説明:</strong><br>${escapeHtml(project.description)}</p>
                    <p><strong>備考:</strong><br>${escapeHtml(project.notes)}</p>
                </div>
            `;
            
            showAlert('プロジェクト詳細', detailHTML, 'info', false);
        }
        
        // プロジェクト保存
        function saveProject() {
            const form = document.getElementById('projectForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const projectData = {
                projectName: document.getElementById('projectName').value,
                customerId: document.getElementById('customerId').value,
                description: document.getElementById('description').value,
                location: document.getElementById('location').value,
                status: document.getElementById('status').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                targetCO2Removal: parseFloat(document.getElementById('targetCO2Removal').value) || 0,
                actualCO2Removal: parseFloat(document.getElementById('actualCO2Removal').value) || 0,
                notes: document.getElementById('notes').value
            };
            
            showLoading(true);
            
            if (isEditMode) {
                const projectId = document.getElementById('projectId').value;
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        handleSaveResult(result, 'プロジェクト情報が更新されました');
                    })
                    .withFailureHandler(function(error) {
                        showAlert('エラー', 'プロジェクト情報の更新に失敗しました: ' + error.message, 'error');
                        showLoading(false);
                    })
                    .updateProjectData(projectId, projectData);
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        handleSaveResult(result, 'プロジェクトが作成されました');
                    })
                    .withFailureHandler(function(error) {
                        showAlert('エラー', 'プロジェクトの作成に失敗しました: ' + error.message, 'error');
                        showLoading(false);
                    })
                    .createProjectData(projectData);
            }
        }
        
        // 保存結果処理
        function handleSaveResult(result, successMessage) {
            showLoading(false);
            
            if (result.success) {
                showAlert('成功', successMessage, 'success');
                $('#projectModal').modal('hide');
                loadProjects();
            } else {
                showAlert('エラー', result.message, 'error');
            }
        }
        
        // プロジェクト削除
        function deleteProject(projectId) {
            const project = allProjects.find(p => p.projectId === projectId);
            if (!project) {
                showAlert('エラー', 'プロジェクトが見つかりません', 'error');
                return;
            }
            
            if (!confirm(`プロジェクト「${project.projectName}」を削除しますか？\n\nこの操作は取り消せません。`)) {
                return;
            }
            
            showLoading(true);
            
            google.script.run
                .withSuccessHandler(function(result) {
                    showLoading(false);
                    
                    if (result.success) {
                        showAlert('成功', 'プロジェクトが削除されました', 'success');
                        loadProjects();
                    } else {
                        showAlert('エラー', result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showAlert('エラー', 'プロジェクトの削除に失敗しました: ' + error.message, 'error');
                    showLoading(false);
                })
                .deleteProjectData(projectId);
        }
        
        // フォームリセット
        function resetForm() {
            document.getElementById('projectForm').reset();
            document.getElementById('projectId').value = '';
        }
        
        // プロジェクトデータ更新
        function refreshProjects() {
            loadProjects();
        }
        
        // ダッシュボードに戻る
        function goBack() {
            window.location.href = '?page=admin-dashboard';
        }
        
        // ユーティリティ関数
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP');
        }
        
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }
        
        function formatNumber(number) {
            if (!number) return '0';
            return parseFloat(number).toLocaleString('ja-JP', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 1 
            });
        }
        
        function getStatusLabel(status) {
            const labels = {
                'planning': '計画中',
                'active': '進行中',
                'on-hold': '一時停止',
                'completed': '完了',
                'cancelled': 'キャンセル'
            };
            return labels[status] || status;
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // ローディング表示
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        // アラート表示
        function showAlert(title, message, type = 'info', autoClose = true) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';
            
            const alertHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" id="${alertId}" role="alert">
                    <strong>${escapeHtml(title)}</strong><br>
                    ${typeof message === 'string' ? escapeHtml(message) : message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            if (autoClose) {
                setTimeout(() => {
                    const alertElement = document.getElementById(alertId);
                    if (alertElement) {
                        $(alertElement).alert('close');
                    }
                }, 5000);
            }
        }
        
        // エラーハンドリング
        window.addEventListener('error', function(e) {
            console.error('Projects page error:', e.error);
            showAlert('エラー', 'ページでエラーが発生しました', 'error');
        });
    </script>
</body>
</html>